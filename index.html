<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /*CSSの記述*/
        body {
            margin: 0;
        }

        .again {
            display: none;
            margin: 0;
            font-size: 8rem;
            color: #fff;
            font-weight: bold;
            text-align: center;
            padding-top: 100px;
        }

        #head {
            margin: 0;
            height: 100px;
            background-color: #d3d3d3;
        }

        .metronome {
            display: flex;
            height: 100%;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .metronome>form {
            margin: 0;
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
        }

        .bpm {
            height: 40px;
            width: 100px;
            text-decoration: none;
            color: #fff;
            font-size: 2rem;
            font-weight: bold;
            background-color: inherit;
            border: none;
            border-bottom: 4px black solid;
            outline: none;
            text-align: center;
        }

        #main-content {
            background-color: #888;
            height: 500px;
        }

        #start {
            background-color: #d3d3d3;
            height: 110px;
            display: flex;
        }

        .start {
            display: flex;
        }

        #start>div {
            display: flex;
            height: 100%;
            width: 100%;
            justify-content: center;
            font-size: 2rem;
            align-items: center;
            font-weight: bold;
            color: #fff;
        }

        .sphere-container {
            width: 100%;
            height: 100px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .sphere {
            background-color: #ffff00;
            height: 70px;
            width: 70px;
            border-radius: 50%;

        }

        .note-wrap {
            font-size: 11rem;
            color: #fff;
            font-weight: bold;
            text-align: center;
            height: 350px;
            margin: 0;
        }

        .description {
            margin: 0;
            font-size: 1.8rem;
            padding-top: 40px;
        }

        .play {
            margin: 0;
            font-size: 8rem;
            color: #fff;
            font-weight: bold;
            text-align: center;
        }

        .countDown {
            display: none;
        }
    </style>
    <title>音階練習アプリ</title>
</head>

<body>
    <div id="head">
        <div class="metronome">
            <form>
                BPMを設定して下さい:<input type="text" name="bpm" class="bpm">
            </form>
        </div>
    </div>
    <div id="main-content">
        <div class="note-wrap">
            <div class="description">
                あそびかた:<br />
                BPMを設定しましょう<br />
                ドレミファソラシの12の音階がランダムに表示されます<br />
                メトロノームに合わせて6弦から順に、その音を鳴らしてみましょう<br />
                1つの弦に対して4拍、6弦分計24拍したら次の音階が表示されます<br /><br />
                これで指板上のすべての音を覚えよう！
            </div>
            <div class="countDown">3</div>
            <div class="note"></div>
            <p class="again">もう1回?</p>
        </div>


        <div class="sphere-container">
            <span class="sphere sphere1"></span>
            <span class="sphere sphere2"></span>
            <span class="sphere sphere3"></span>
            <span class="sphere sphere4"></span>
        </div>

    </div>
    <div id="start">
        <div class="start">スタート</div>
    </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>

        let id = "";

        let count = 1;

        let tempo = 140;
        //let tempo;

        //ランダムに音階を表示するメソッド
        const showNote = () => {
            //音階を配列に格納
            const note = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'A♭', 'B♭', 'D♭', 'E♭', 'G♭'];

            //メトロノームに合わせてインターバル
            let id = setInterval((function first() {

                //配列の中身がなくなったらインターバル終了
                if (note.length <= 0) {
                    clearInterval(id);
                    $('.note').css('display', 'none');
                    $('.again').css('display', 'block');
                    $('.start').css('display', 'flex');

                    count = note.length;
                }
                //ランダム数を生成し、画面に表示
                let rnd = 0;
                rnd = Math.floor(Math.random() * note.length);
                $('.note').text(note[rnd]);

                //1度表示したノートを配列から削除
                note.splice(rnd, 1);

                //配列中身確認用、リリースの際に削除
                console.log(note);

                //最初の1回はセットインターバルを無視
                return first;

            }()), 60 / tempo * 1000 * 4);
        }

        //メトロノームのメソッド
        const metronome = () => {

            console.log(tempo);
            //音楽ファイルを読み込み
            const music = new Audio('btn03.mp3');
            const sphere = $(['.sphere1', '.sphere2', '.sphere3', '.sphere4']);
            let num = 0;

            //音階の表示に合わせてインターバル
            let id2 = setInterval((function first() {

                if (count === 0) {
                    clearInterval(id2);
                    count = 1;
                }

                music.play();

                //tempoに合わせてsphereを点滅、num=4を超えたらリセットし、点滅をループ
                $(sphere[num]).fadeOut(0, function () { $(this).fadeIn(60 / tempo * 1000) });
                num++;
                if (num >= sphere.length) num = 0;

                return first;

            }()), 60 / tempo * 1000);
        }

        //カウントダウンのメソッド
        const countDown = resolve => {
            let p = 3;

            let countInterval = setInterval(() => {
                $('.countDown').css('display', 'block');
                $('.countDown').text(p--);
                if (p < 0) {
                    clearInterval(countInterval);
                    resolve();
                    $('.note').css('display', 'block');
                }
            }, 1000)
        }

        //スタートを押したときの処理
        $('.start').on('click', () => {
            $('.description').css('display', 'none');
            $('.start').css('display', 'none');
            $('.again').css('display', 'none');
            gameStart();
        })

        //メトロノームに合わせて音階を表示する処理
        const noteByMetro = () => {
            $('.countDown').css('display', 'none');

            showNote();

            setTimeout(() => {
                metronome();
            }, 500);
        }

        //ゲームスタートの処理
        const gameStart = () => {

            //tempo = $('[class ="bpm"]').val();

            if (!tempo || '') {
                alert('BPMを入力してください');
                $('.bpm').css('border', '2px red solid');
            } else if (tempo > 160 || tempo < 60) {
                alert('BPMは60~160の間で設定してください')
            } else {
                /*
                $('.description').css('display', 'none');
                $('.note').css('display', 'block');
                $('.start').css('display', 'none');
                $('.again').css('display', 'none');
                */

                console.log('gameStart' + tempo);
                new Promise(countDown).then(noteByMetro);

            }
        }
    </script>


</body>

</html>